# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: QuoteOfTheDayAZD
metadata:
    template: azd-init@1.9.0
hooks:
    prepackage:
        shell: pwsh
        run: |
            Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass 
            ./infra/Setup-CreateDatabase.ps1
            ./infra/Setup-SplitExperimentationEntraApp.ps1
        interactive: true
        continueOnError: false
    postprovision:
        shell: pwsh
        run: |
            Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass 
            ./infra/Setup-QuoteOfTheDayExperiment.ps1 -SubscriptionId $env:AZURE_SUBSCRIPTION_ID -WorkspaceName $env:AZURE_SPLIT_WORKSPACE_NAME -AppConfigurationName $env:AZURE_APPCONFIGURATION_NAME
            $folderPath = "./.azure/$env:AZURE_ENV_NAME"
            $envFile = Get-ChildItem -Path $folderPath -Filter "*.env" | Select-Object -First 1
            $envFilePath = $envFile.FullName
            $appConfigurationConnectionStringEnvVarName = "AzureAppConfigurationConnectionString"
            $appInsightsConnectionStringEnvVarName = "ApplicationInsightsConnectionString"
            $appConfigurationConnectionStringEnvLine = (Get-Content $envFilePath) | Where-Object { $_ -match $appConfigurationConnectionStringEnvVarName }
            $appInsightsConnectionStringEnvLine = (Get-Content $envFilePath) | Where-Object { $_ -match $appInsightsConnectionStringEnvVarName }
            $envLineParts = $appConfigurationConnectionStringEnvLine -split "=", 2
            $env:AzureAppConfigurationConnectionString = $envLineParts[1].Trim()
            $envLineParts = $appInsightsConnectionStringEnvLine -split "=", 2
            $env:ApplicationInsightsConnectionString = $envLineParts[1].Trim()
            dotnet run --project ./QuoteOfTheDay/QuoteOfTheDay.csproj
        interactive: true
        continueOnError: false 
services:
    QuoteOfTheDay:
        project: QuoteOfTheDay
        host: containerapp
        language: dotnet
